---
description: Quality tooling configuration and CI pipeline for Symfony bundles
globs: Makefile, grumphp.yml, phpstan.neon.dist, .php-cs-fixer.dist.php, infection.json5, deptrac.yaml, .github/**/*.yml
alwaysApply: false
---

# Bundle Quality Tooling

## Makefile First

The Makefile is the SINGLE entry point for all quality operations.
Never call `vendor/bin/` directly — always use `make` targets:

- `make cs-fix` — fix code style
- `make cs-check` — check without fixing
- `make phpstan` — static analysis level 9
- `make test` — run PHPUnit
- `make deptrac` — architecture enforcement
- `make infection` — mutation testing
- `make security-check` — `composer audit --abandoned=report`
- `make quality` — full pipeline (cs-check + phpstan + deptrac + lint + test + infection)
- `make ci` — security-check + quality
- `make install-hooks` — install git hook that strips Co-authored-by from commit messages (optional, run after clone if the IDE adds it)

Never commit code that fails `make quality`.

## Commits (no self-attribution)

Do not add Co-authored-by, Signed-off-by from the AI, or `git commit --trailer`. If the IDE adds Co-authored-by automatically, add a git hook: `scripts/git-hooks/commit-msg` that strips lines matching `Co-authored-by:`, and `make install-hooks` to copy it to `.git/hooks/commit-msg`. See symfony-bundle.mdc § Commits.

## PHPStan Level 9

- No `@phpstan-ignore` without explanatory comment
- No `mixed` without justification
- Typed collections: `/** @var Collection<int, Entity> */`
- Typed repository returns: `@return Entity[]`
- `@param array{key: type}` for shaped arrays (especially `loadExtension()` config)

## PHP-CS-Fixer

- `@Symfony` + `@PHP82Migration`
- `declare_strict_types` enforced
- `native_function_invocation` with `@compiler_optimized`
- `trailing_comma_in_multiline` on arguments, parameters, match, arrays
- `ordered_imports` alphabetical
- Always use `.php-cs-fixer.dist.php` (not `.php-cs-fixer.php`)

## GrumPHP

Pre-commit hooks must mirror CI (except security): phpstan, phpcsfixer, phpunit, deptrac, infection. Same thresholds as Makefile (e.g. infection `min_covered_msi: 65`). This way a commit that would fail CI (e.g. 0% MSI) is blocked locally.
Note: `composer_audit` is NOT a valid GrumPHP task — use `make security-check` separately.

## Composer allow-plugins

Always configure in `composer.json`:
- `infection/extension-installer: true`
- `phpro/grumphp: true`

## Deptrac

- Entity depends on nothing (or Contract)
- Service never imports Controller
- Contract imports nothing internal
- Controller goes through Service, not Repository directly

## Infection

- MSI >= 70% (or 65% with documented justification, e.g. mutants escaping scope such as prependExtension path)
- `--only-covered`, threads max
- Always run after `make test`

## CI (GitHub Actions)

- Either run `make ci` (includes lint), or replicate as separate jobs: security, cs, phpstan, deptrac in parallel → tests (matrix PHP 8.2-8.4 × Symfony 7+8) → infection
- Matrix: use explicit Symfony versions (e.g. `7.1.*`, `7.2.*`, `8.0.*`). Exclusions can be multiple (e.g. `{ php: '8.2', symfony: '8.0.*' }`, `{ php: '8.3', symfony: '8.0.*' }`) depending on PHP/Symfony compatibility
- If using separate jobs: include **lint** (e.g. in the cs job) or omit when the bundle has no `config/*.xml` (lint is then no-op)
- `fail-fast: false` on test matrix
- Symfony deps: always `^7.0 || ^8.0`

## .gitignore essentials

```
/vendor/
composer.lock
.phpstan-cache/
.php-cs-fixer.cache
.deptrac.cache
.phpunit.result.cache
infection.log
infection-summary.log
phpunit.xml
phpstan.neon
*.log
```

## Dependencies

- Deptrac: use `deptrac/deptrac` (not the abandoned `qossmic/deptrac`)
- Always use `composer audit --abandoned=report` so abandoned packages are reported but only security vulnerabilities fail the build

## Anti-Patterns

- Calling `vendor/bin/` directly instead of Makefile targets
- `phpstan.neon` instead of `.dist` (overridden locally)
- MSI < 50% (tests don't verify behavior)
- Ignoring deprecations
- No `composer audit` in CI
- No Deptrac (architecture erodes)
- `composer_audit` in grumphp.yml (task does not exist)
- `composer audit` without `--abandoned=report` (fails CI on abandoned transitive deps)
- Using `qossmic/deptrac` instead of `deptrac/deptrac` (abandoned)
